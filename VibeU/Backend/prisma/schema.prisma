generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(uuid())
  username          String    @unique
  phone             String?   @unique
  email             String?   @unique
  password          String?   // For email/password auth
  appleId           String?   @unique @map("apple_id")
  googleId          String?   @unique @map("google_id")
  
  displayName       String    @map("display_name")
  dateOfBirth       DateTime  @map("date_of_birth")
  gender            String    // male, female, non_binary, prefer_not_to_say
  country           String
  city              String
  bio               String?
  profilePhotoUrl   String    @map("profile_photo_url")
  
  tiktokUsername    String?   @map("tiktok_username")
  instagramUsername String?   @map("instagram_username")
  snapchatUsername  String?   @map("snapchat_username")
  
  // Keşfet modu (local/global)
  showMode          String    @default("local") @map("show_mode")
  
  isPremium         Boolean   @default(false) @map("is_premium")
  premiumExpiresAt  DateTime? @map("premium_expires_at")
  isVerified        Boolean   @default(false) @map("is_verified")
  isBanned          Boolean   @default(false) @map("is_banned")
  banReason         String?   @map("ban_reason")
  
  latitude          Float?
  longitude         Float?
  
  deviceFingerprint String?   @map("device_fingerprint")
  lastActiveAt      DateTime  @default(now()) @map("last_active_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  photos            UserPhoto[]
  tags              UserTag[]
  interests         UserInterest[]
  
  sentLikes         Like[]      @relation("SentLikes")
  receivedLikes     Like[]      @relation("ReceivedLikes")
  
  sentRequests      Request[]   @relation("SentRequests")
  receivedRequests  Request[]   @relation("ReceivedRequests")
  
  friendshipsA      Friendship[] @relation("FriendshipA")
  friendshipsB      Friendship[] @relation("FriendshipB")
  
  favorites         Favorite[]  @relation("UserFavorites")
  favoritedBy       Favorite[]  @relation("FavoritedUser")
  
  skippedUsers      SkippedUser[] @relation("SkippedBy")
  skippedByUsers    SkippedUser[] @relation("SkippedUser")
  
  sentReports       Report[]    @relation("Reporter")
  receivedReports   Report[]    @relation("ReportedUser")
  
  boosts            Boost[]
  purchases         Purchase[]
  notifications     Notification[]
  
  @@index([country, city])
  @@map("users")
}

model UserPhoto {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  url              String
  thumbnailUrl     String?  @map("thumbnail_url")
  orderIndex       Int      @map("order_index")
  isPrimary        Boolean  @default(false) @map("is_primary")
  moderationStatus String   @default("pending") @map("moderation_status")
  createdAt        DateTime @default(now()) @map("created_at")
  
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, orderIndex])
  @@map("user_photos")
}

model UserTag {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  tagCode    String   @map("tag_code")
  orderIndex Int      @map("order_index")
  createdAt  DateTime @default(now()) @map("created_at")
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, tagCode])
  @@unique([userId, orderIndex])
  @@map("user_tags")
}

model Interest {
  id       String         @id @default(uuid())
  code     String         @unique
  nameEn   String         @map("name_en")
  nameEs   String         @map("name_es")
  namePt   String         @map("name_pt")
  nameFr   String         @map("name_fr")
  nameTr   String         @map("name_tr")
  emoji    String?
  category String
  
  users    UserInterest[]
  
  @@map("interests")
}

model UserInterest {
  userId     String   @map("user_id")
  interestId String   @map("interest_id")
  createdAt  DateTime @default(now()) @map("created_at")
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)
  
  @@id([userId, interestId])
  @@map("user_interests")
}

model Like {
  id           String   @id @default(uuid())
  fromUserId   String   @map("from_user_id")
  toUserId     String   @map("to_user_id")
  createdAt    DateTime @default(now()) @map("created_at")
  
  fromUser     User     @relation("SentLikes", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser       User     @relation("ReceivedLikes", fields: [toUserId], references: [id], onDelete: Cascade)
  
  @@unique([fromUserId, toUserId])
  @@map("likes")
}

model Request {
  id           String    @id @default(uuid())
  fromUserId   String    @map("from_user_id")
  toUserId     String    @map("to_user_id")
  status       String    @default("pending") // pending, accepted, rejected, cancelled
  createdAt    DateTime  @default(now()) @map("created_at")
  respondedAt  DateTime? @map("responded_at")
  
  fromUser     User      @relation("SentRequests", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser       User      @relation("ReceivedRequests", fields: [toUserId], references: [id], onDelete: Cascade)
  
  @@unique([fromUserId, toUserId])
  @@map("requests")
}

model Friendship {
  id        String   @id @default(uuid())
  userAId   String   @map("user_a_id")
  userBId   String   @map("user_b_id")
  createdAt DateTime @default(now()) @map("created_at")
  
  userA     User     @relation("FriendshipA", fields: [userAId], references: [id], onDelete: Cascade)
  userB     User     @relation("FriendshipB", fields: [userBId], references: [id], onDelete: Cascade)
  
  @@unique([userAId, userBId])
  @@map("friendships")
}

model Favorite {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  favoritedUserId String   @map("favorited_user_id")
  createdAt       DateTime @default(now()) @map("created_at")
  
  user            User     @relation("UserFavorites", fields: [userId], references: [id], onDelete: Cascade)
  favoritedUser   User     @relation("FavoritedUser", fields: [favoritedUserId], references: [id], onDelete: Cascade)
  
  @@unique([userId, favoritedUserId])
  @@map("favorites")
}

model SkippedUser {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  skippedUserId String   @map("skipped_user_id")
  createdAt     DateTime @default(now()) @map("created_at")
  expiresAt     DateTime @map("expires_at")
  
  user          User     @relation("SkippedBy", fields: [userId], references: [id], onDelete: Cascade)
  skippedUser   User     @relation("SkippedUser", fields: [skippedUserId], references: [id], onDelete: Cascade)
  
  @@unique([userId, skippedUserId])
  @@map("skipped_users")
}

model Report {
  id             String    @id @default(uuid())
  reporterId     String    @map("reporter_id")
  reportedUserId String    @map("reported_user_id")
  reason         String    // fake_profile, inappropriate_content, harassment, spam, underage, other
  description    String?
  status         String    @default("pending") // pending, reviewed, action_taken, dismissed
  adminNotes     String?   @map("admin_notes")
  reviewedBy     String?   @map("reviewed_by")
  createdAt      DateTime  @default(now()) @map("created_at")
  reviewedAt     DateTime? @map("reviewed_at")
  
  reporter       User      @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser   User      @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)
  
  @@map("reports")
}

model Boost {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  boostType String   @map("boost_type") // 30min, 1hour, 6hour
  multiplier Float   @default(2.0)
  startedAt DateTime @default(now()) @map("started_at")
  expiresAt DateTime @map("expires_at")
  isActive  Boolean  @default(true) @map("is_active")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("boosts")
}

model Purchase {
  id                    String    @id @default(uuid())
  userId                String    @map("user_id")
  productId             String    @map("product_id")
  transactionId         String    @unique @map("transaction_id")
  originalTransactionId String?   @map("original_transaction_id")
  purchaseType          String    @map("purchase_type") // subscription, consumable
  amount                Float?
  currency              String?
  status                String    @default("completed")
  receiptData           String?   @map("receipt_data")
  createdAt             DateTime  @default(now()) @map("created_at")
  expiresAt             DateTime? @map("expires_at")
  
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("purchases")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   // request_received, request_accepted, new_friend, boost_expired, premium_expiring, system
  titleKey  String   @map("title_key")
  bodyKey   String   @map("body_key")
  data      String?  // JSON string
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
}

model RateLimit {
  id          String   @id @default(uuid())
  visitorId   String   @map("visitor_id")
  actionType  String   @map("action_type")
  count       Int      @default(0)
  windowStart DateTime @map("window_start")
  windowEnd   DateTime @map("window_end")
  
  @@unique([visitorId, actionType, windowStart])
  @@map("rate_limits")
}

model Cooldown {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  targetUserId String   @map("target_user_id")
  actionType   String   @map("action_type")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  
  @@unique([userId, targetUserId, actionType])
  @@map("cooldowns")
}

// =====================================================
// APP LOGS
// =====================================================

model AppLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())
  level     String   // DEBUG, INFO, WARNING, ERROR, CRITICAL
  category  String   // Auth, Premium, Discover, Chat, Profile, etc.
  message   String
  metadata  String?  // JSON string
  userId    String?  @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([level])
  @@index([category])
  @@index([userId])
  @@index([timestamp])
  @@map("app_logs")
}

// =====================================================
// USER SETTINGS
// =====================================================

model UserSettings {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  
  // Appearance
  theme             String   @default("dark") // dark, light, system
  language          String   @default("tr") // tr, en, es, pt, fr
  
  // Notifications
  pushNotifications Boolean  @default(true) @map("push_notifications")
  matchNotifications Boolean @default(true) @map("match_notifications")
  messageNotifications Boolean @default(true) @map("message_notifications")
  likeNotifications Boolean  @default(true) @map("like_notifications")
  
  // Privacy
  hideAge           Boolean  @default(false) @map("hide_age")
  hideDistance      Boolean  @default(false) @map("hide_distance")
  hideOnlineStatus  Boolean  @default(false) @map("hide_online_status")
  readReceipts      Boolean  @default(true) @map("read_receipts")
  
  // Location
  locationEnabled   Boolean  @default(true) @map("location_enabled")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("user_settings")
}

// =====================================================
// DISCOVER FILTERS
// =====================================================

model DiscoverFilters {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  
  // Age Range
  minAge            Int      @default(18) @map("min_age")
  maxAge            Int      @default(50) @map("max_age")
  
  // Distance
  maxDistance       Int      @default(100) @map("max_distance") // km
  
  // Gender Preference
  showMen           Boolean  @default(true) @map("show_men")
  showWomen         Boolean  @default(true) @map("show_women")
  showNonBinary     Boolean  @default(true) @map("show_non_binary")
  
  // Activity
  onlyActive        Boolean  @default(false) @map("only_active") // Son 24 saat aktif
  onlyVerified      Boolean  @default(false) @map("only_verified")
  onlyWithPhotos    Boolean  @default(true) @map("only_with_photos")
  
  // Advanced (Premium)
  onlyWithBio       Boolean  @default(false) @map("only_with_bio")
  hideAlreadySeen   Boolean  @default(false) @map("hide_already_seen")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("discover_filters")
}

// =====================================================
// DOUBLE DATE MODELS
// =====================================================

// Çifte Randevu Takımı - Kullanıcı ve arkadaşlarından oluşan grup
model DoubleDateTeam {
  id          String   @id @default(uuid())
  ownerId     String   @map("owner_id")
  name        String?  // Opsiyonel takım adı
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  members     DoubleDateTeamMember[]
  sentLikes   DoubleDateLike[] @relation("SentDoubleDateLikes")
  receivedLikes DoubleDateLike[] @relation("ReceivedDoubleDateLikes")
  matchesAsTeamA DoubleDateMatch[] @relation("MatchTeamA")
  matchesAsTeamB DoubleDateMatch[] @relation("MatchTeamB")
  
  @@map("double_date_teams")
}

// Takım Üyeleri
model DoubleDateTeamMember {
  id        String   @id @default(uuid())
  teamId    String   @map("team_id")
  userId    String   @map("user_id")
  role      String   @default("member") // owner, member
  status    String   @default("pending") // pending, accepted, rejected
  joinedAt  DateTime? @map("joined_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  team      DoubleDateTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId])
  @@map("double_date_team_members")
}

// Çifte Randevu Davetleri
model DoubleDateInvite {
  id           String    @id @default(uuid())
  fromUserId   String    @map("from_user_id")
  toUserId     String    @map("to_user_id")
  teamId       String?   @map("team_id") // Hangi takıma davet
  status       String    @default("pending") // pending, accepted, rejected, expired
  message      String?   // Opsiyonel davet mesajı
  createdAt    DateTime  @default(now()) @map("created_at")
  respondedAt  DateTime? @map("responded_at")
  expiresAt    DateTime  @map("expires_at")
  
  @@unique([fromUserId, toUserId, teamId])
  @@map("double_date_invites")
}

// Takımlar arası beğeniler
model DoubleDateLike {
  id           String   @id @default(uuid())
  fromTeamId   String   @map("from_team_id")
  toTeamId     String   @map("to_team_id")
  likedByUserId String  @map("liked_by_user_id") // Beğeniyi yapan kullanıcı
  createdAt    DateTime @default(now()) @map("created_at")
  
  fromTeam     DoubleDateTeam @relation("SentDoubleDateLikes", fields: [fromTeamId], references: [id], onDelete: Cascade)
  toTeam       DoubleDateTeam @relation("ReceivedDoubleDateLikes", fields: [toTeamId], references: [id], onDelete: Cascade)
  
  @@unique([fromTeamId, toTeamId])
  @@map("double_date_likes")
}

// Çifte Randevu Eşleşmeleri
model DoubleDateMatch {
  id          String   @id @default(uuid())
  teamAId     String   @map("team_a_id")
  teamBId     String   @map("team_b_id")
  status      String   @default("active") // active, ended, blocked
  createdAt   DateTime @default(now()) @map("created_at")
  
  teamA       DoubleDateTeam @relation("MatchTeamA", fields: [teamAId], references: [id], onDelete: Cascade)
  teamB       DoubleDateTeam @relation("MatchTeamB", fields: [teamBId], references: [id], onDelete: Cascade)
  
  @@unique([teamAId, teamBId])
  @@map("double_date_matches")
}
