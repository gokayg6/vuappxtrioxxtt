rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Temel Yetkilendirme Fonksiyonları
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ----------------------------
    // USERS & PROFILES
    // ----------------------------
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(userId); // Sadece sahibi profilini güncelleyebilir
      allow delete: if isOwner(userId);
      
      // Kullanıcı alt koleksiyonları (streak, photos, vb.)
      match /{subcollection}/{document=**} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // ----------------------------
    // MATCHING SYSTEM (Speed Date & Voice) - KRİTİK EKLENTİ
    // ----------------------------
    match /match_queue/{userId} {
      // Kuyruğa girmek ve eşleşme aramak için okuma/yazma izni gerekli
      // Başkasının dokümanını yazmak (Eşleşme onayı için) gerekli olduğu için
      // authenticated kullanıcılara izin veriyoruz.
      allow read, write: if isAuthenticated();
    }
    
    match /matches/{matchId} {
      allow read, create, delete: if isAuthenticated();
      allow update: if false; // Eşleşmeler değiştirilemez, silinip yenisi oluşturulur
    }

    // ----------------------------
    // LIKES & INTERACTIONS - KRİTİK EKLENTİ
    // ----------------------------
    match /likes/{likeId} {
      allow read, write: if isAuthenticated();
    }
    
    match /friend_requests/{requestId} {
      allow read, write: if isAuthenticated();
    }
    
    // ----------------------------
    // COMMUNICATION
    // ----------------------------
    match /messages/{messageId} {
      allow read, create, delete: if isAuthenticated();
      // Mesajlar değiştirilemez (Update kapalı)
      allow update: if false;
    }
    
    match /notifications/{notificationId} {
      allow read, write: if isAuthenticated();
    }

    // ----------------------------
    // DOUBLE DATES
    // ----------------------------
    match /double_date_teams/{teamId} {
      allow read, write: if isAuthenticated();
    }
    
    match /double_date_invites/{inviteId} {
      allow read, write: if isAuthenticated();
    }
    
    match /double_date_matches/{matchId} {
      allow read, create, delete: if isAuthenticated();
      allow update: if false;
    }
    
    // ----------------------------
    // EXPLORE & EVENTS
    // ----------------------------
    match /live_events/{eventId} {
      allow read: if isAuthenticated();
      // Etkinlik oluşturma admin panelinden yapılmalı, ancak kullanıcılar katılım için yazabilir mi?
      // Geçici olarak write açık, production'da kapatılmalı
      allow write: if isAuthenticated();
    }
    
    // Yeni Keşfet Özellikleri (Restoranlar, Kitaplar vb.)
    match /restaurants/{docId} { allow read: if isAuthenticated(); }
    match /books/{docId} { allow read: if isAuthenticated(); }
    match /games/{docId} { allow read: if isAuthenticated(); }
    match /music/{docId} { allow read: if isAuthenticated(); }
    
    // ----------------------------
    // SYSTEM & SECURITY
    // ----------------------------
    match /diamond_transactions/{transactionId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    match /reports/{reportId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    match /blocks/{blockId} {
      allow read, create, delete: if isAuthenticated();
      allow update: if false;
    }
    
    match /logs/{logId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    match /admin/{document=**} {
      allow read, write: if false;
    }
  }
}
